"""Промпты для анализа кода через LLM."""

CODE_REVIEW_PROMPT = """Ты — опытный code reviewer. Проанализируй изменения во ВСЕХ файлах Merge Request и дай вердикт по КАЖДОМУ файлу отдельно.

**Контекст Merge Request:**
- Название: {mr_title}
- Описание: {mr_description}
- Автор: {author_name}
- Ветки: {source_branch} → {target_branch}

**Изменения во всех файлах:**
{all_diffs}

**Твоя задача:**
1. Проанализируй КАЖДЫЙ файл отдельно
2. Для КАЖДОГО файла определи:
   - ЧТО пытались изменить (какая функциональность добавлена/изменена)
   - Найди проблемы: баги, уязвимости безопасности, ошибки логики, плохие практики
   - Вынеси вердикт: APPROVE / CHANGES_REQUESTED / REJECT
   - Объясни ПОЧЕМУ такой вердикт (простыми словами, без смайликов)
3. Для каждой проблемы объясни ПРОСТЫМИ СЛОВАМИ:
   - ЧТО не так (что именно неправильно)
   - ПОЧЕМУ это проблема (какие последствия могут быть)
   - КАК исправить (конкретные шаги простыми словами)

**ФОРМАТ ОТВЕТА - ВАЖНО!**
Ты ДОЛЖЕН вернуть ТОЛЬКО валидный JSON объект, БЕЗ markdown блоков, БЕЗ дополнительного текста, БЕЗ смайликов в тексте.

Пример правильного ответа:
{{
  "files": [
    {{
      "file_path": "src/main.py",
      "what_changed": "Добавлена функция аутентификации пользователя с проверкой пароля",
      "verdict": "CHANGES_REQUESTED",
      "verdict_explanation": "Найдены проблемы безопасности: жестко закодированный пароль и отсутствие хеширования. Это небезопасно, пароль может попасть в публичный репозиторий",
      "critical_issues": [
        {{
          "line": 15,
          "type": "security",
          "message": "Используется жестко закодированный пароль в коде",
          "why": "Это небезопасно, пароль может попасть в публичный репозиторий и злоумышленник получит доступ",
          "fix": "Используй переменные окружения: os.getenv('PASSWORD') или секретное хранилище"
        }}
      ],
      "suggestions": [
        "Добавь проверку на None перед использованием переменных"
      ]
    }},
    {{
      "file_path": "src/utils.py",
      "what_changed": "Добавлена вспомогательная функция для форматирования даты",
      "verdict": "APPROVE",
      "verdict_explanation": "Код написан хорошо, использует стандартные библиотеки, есть обработка ошибок",
      "critical_issues": [],
      "suggestions": [
        "Можно добавить type hints для лучшей читаемости"
      ]
    }}
  ]
}}

**КРИТИЧЕСКИ ВАЖНО:**
- Объясняй ВСЕ простыми словами, как будто объясняешь коллеге
- Для КАЖДОГО файла укажи: что изменено, вердикт и почему такой вердикт
- Для каждой проблемы укажи: ЧТО не так, ПОЧЕМУ это проблема, КАК исправить
- НЕ используй смайлики в тексте ответа
- Будь конкретным: указывай точные файлы, строки, и что именно там не так
- Если проблема критичная (баг, уязвимость) — вердикт должен быть CHANGES_REQUESTED или REJECT
"""


def format_review_prompt(
    mr_title: str,
    mr_description: str,
    author_name: str,
    target_branch: str,
    source_branch: str,
    all_diffs: str
) -> str:
    """Форматирует промпт для анализа всех файлов."""
    return CODE_REVIEW_PROMPT.format(
        mr_title=mr_title,
        mr_description=mr_description or "(нет описания)",
        author_name=author_name,
        target_branch=target_branch,
        source_branch=source_branch,
        all_diffs=all_diffs
    )
